<%@ taglib prefix="cms" uri="http://www.opencms.org/taglib/cms"  %>
<%@ page import="com.opencms.flex.util.*,com.opencms.flex.cache.*,com.opencms.flex.*,com.opencms.core.*" %>
<%@ page import="java.util.*" %>
<html>

<script language=JavaScript>
<!--
top.head.helpUrl='administration/index.html';
//-->
</script>

<head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">

<title>Flex Cache Administration</title>
<link rel=stylesheet type="text/css" href="<cms:link>/system/workplace/resources/format.css</cms:link>">

</head>
<body
    bgcolor="#ffffff"
    background="<cms:link>/system/workplace/resources/bg_weiss.gif</cms:link>"
    bgproperties=fixed
    onLoad="window.top.body.admin_head.location.href='<cms:link>/system/workplace/action/administration_head.html</cms:link>';">


<h1>Flex Cache Administration</h1>

<%
    int sizeEntries = 0;
    int sizeKeys = 0;
    CmsFlexCache cache = null;
    com.opencms.file.CmsObject cms = null;
    int maxCacheByteSize = 0;
    int avgCacheByteSize = 0;
    int currentCacheByteSize = 0;
    int currentCacheObjectCount = 0;
    CmsFlexLruCache entryLruCache = null;

    String label_1 = "Clear entries only";
    String label_2 = "Clear cache keys and entries completely";
    String label_5 = "Clear only online entries";
    String label_6 = "Clear only online keys and entries";
    String label_7 = "Clear only offline entries";
    String label_8 = "Clear only offline keys and entries";
    String label_9 = "Purge JSP repository";
    String label_3 = "Show cached resources with keys";
    String label_4 = "Show cached resources with keys and entries";
    String label_10 = "Reload this page";

    out = pageContext.getOut();

    if (request instanceof CmsFlexRequest) {
        // out.write("<h3>CmsFlexRequest found!</h3>");

        CmsFlexRequest req = (CmsFlexRequest)request;

        cache = req.getCmsCache();
        cms = req.getCmsObject();
    } else {
        out.write("<h3>NO CmsFlexRequest!</h3>");
    }

    String action = request.getParameter("action");
    // out.write("Request action is: " + action);

    if (action != null) {
        if (label_1.equals(action)) {
            // cache.clearEntries(cms);
            A_OpenCms.fireCmsEvent(new CmsEvent(cms, I_CmsEventListener.EVENT_FLEX_CACHE_CLEAR, Collections.singletonMap("action", new Integer(CmsFlexCache.C_CLEAR_ENTRIES))));
        } else if (label_2.equals(action)) {
            // cache.clear(cms);
            A_OpenCms.fireCmsEvent(new CmsEvent(cms, I_CmsEventListener.EVENT_FLEX_CACHE_CLEAR, Collections.singletonMap("action", new Integer(CmsFlexCache.C_CLEAR_ALL))));
        } else if (label_6.equals(action)) {
            // cache.clearOnline(cms);
            A_OpenCms.fireCmsEvent(new CmsEvent(cms, I_CmsEventListener.EVENT_FLEX_CACHE_CLEAR, Collections.singletonMap("action", new Integer(CmsFlexCache.C_CLEAR_ONLINE_ALL))));
        } else if (label_5.equals(action)) {
            // cache.clearOnlineEntries(cms);
            A_OpenCms.fireCmsEvent(new CmsEvent(cms, I_CmsEventListener.EVENT_FLEX_CACHE_CLEAR, Collections.singletonMap("action", new Integer(CmsFlexCache.C_CLEAR_ONLINE_ENTRIES))));
        } else if (label_8.equals(action)) {
            // cache.clearOffline(cms);
            A_OpenCms.fireCmsEvent(new CmsEvent(cms, I_CmsEventListener.EVENT_FLEX_CACHE_CLEAR, Collections.singletonMap("action", new Integer(CmsFlexCache.C_CLEAR_OFFLINE_ALL))));
        } else if (label_7.equals(action)) {
            // cache.clearOfflineEntries(cms);
            A_OpenCms.fireCmsEvent(new CmsEvent(cms, I_CmsEventListener.EVENT_FLEX_CACHE_CLEAR, Collections.singletonMap("action", new Integer(CmsFlexCache.C_CLEAR_OFFLINE_ENTRIES))));
        } else if (label_9.equals(action)) {
            // cache.purgeJspRepository(cms);
            // cache.clear(cms);
            A_OpenCms.fireCmsEvent(new CmsEvent(cms, I_CmsEventListener.EVENT_FLEX_PURGE_JSP_REPOSITORY, new HashMap(0), true));
            A_OpenCms.fireCmsEvent(new CmsEvent(cms, I_CmsEventListener.EVENT_FLEX_CACHE_CLEAR, Collections.singletonMap("action", new Integer(CmsFlexCache.C_CLEAR_ENTRIES))));
        }
    }

    if (cache != null) {
        sizeEntries = cache.size();
        sizeKeys = cache.keySize();

        entryLruCache = cache.getEntryLruCache();

        if (entryLruCache!=null) {
            maxCacheByteSize = entryLruCache.getMaxCacheCosts();
            avgCacheByteSize = entryLruCache.getAvgCacheCosts();
            currentCacheByteSize = entryLruCache.getObjectCosts();
            currentCacheObjectCount = entryLruCache.size();
        }
    }
%>

<blockquote>

<table border="0" cellpadding="3" cellspacing="0">
<tr>
	<td class="wizardbig"><b>Entries in Flex Cache:</b></td>
	<td class="wizardbig" align="right"><font color="red"><b><%=sizeEntries%></b></font></td>
	<td>&nbsp;</td>
</tr>
<tr>
	<td class="wizardbig"><b>Keys in Flex Cache:</b></td>
	<td class="wizardbig" align="right"><font color="red"><b><%=sizeKeys%></b></font></td>
	<td>&nbsp;</td>
</tr>
<tr>
	<td class="wizardbig"><b>Max. size of all entries:</b></td>
	<td class="wizardbig" align="right"><font color="red"><b><%=maxCacheByteSize%></b></font></td>
	<td class="wizardbig"><b>bytes</b></td>
</tr>
<tr>
	<td class="wizardbig"><b>Avg. size of all entries:</b></td>
	<td class="wizardbig" align="right"><font color="red"><b><%=avgCacheByteSize%></b></font></td>
	<td class="wizardbig"><b>bytes</b></td>
</tr>
<tr>
	<td class="wizardbig"><b>Cur. size of all entries:</b></td>
	<td class="wizardbig" align="right"><font color="red"><b><%=currentCacheByteSize%></b></font></td>
	<td class="wizardbig"><b>bytes</b></td>
</tr>
</table>

</blockquote>

<form action="<%=request.getRequestURI()%>">
<table border="0" cellpadding="3" cellspacing="0">
<tr>
    <td><input type="submit" name="action" value="<%= label_10 %>"></td>
</tr>
</table>
</form>


<h2>Clear Cache options</h2>

<form method="POST" action="index.html">
<table border="0" cellpadding="3" cellspacing="0">
<tr>
	<td><input type="submit" name="action" value="<%= label_1 %>"></td>
	<td><input type="submit" name="action" value="<%= label_2 %>"></td>
</tr>
</table>
<%
    if (cache.cacheOffline()) {
%>
<h3>Clear online / offline cache options</h3>
<table border="0" cellpadding="3" cellspacing="0">
<tr>
	<td><b>Online</b> cache</td>
	<td><b>Offline</b> cache</td>
</tr>
<tr>
	<td><input type="submit" name="action" value="<%= label_5 %>"></td>
	<td><input type="submit" name="action" value="<%= label_7 %>"></td>
</tr><tr>
	<td><input type="submit" name="action" value="<%= label_6 %>"></td>
	<td><input type="submit" name="action" value="<%= label_8 %>"></td>
</tr>

</table>
<%
    }
%>

<h2>JSP options</h2>

<table border="0" cellpadding="3" cellspacing="0">
<tr>
    <td><input type="submit" name="action" value="<%= label_9 %>"></td>
</tr>
</table>

<h2>Currently cached resources</h2>

<table border="0" cellpadding="3" cellspacing="0">
<tr>
    <td><input type="submit" name="action" value="<%= label_3 %>"></td>
    <td><input type="submit" name="action" value="<%= label_4 %>"></td>
</tr>
</table>
</form>

<%
    if ((action != null) && (cache != null)) {
        if (label_3.equals(action) || label_4.equals(action)) {

            boolean showall = false;
            if (label_4.equals(action)) {
                showall = true;
                out.write("<h1>Cached resources with keys and entries:</h1>");
            } else {
                out.write("<h1>Cached resources with keys:</h1>");
            }

            Set set = cache.getCachedResources(cms);

            if (cache.cacheOffline()) {
                List online = new ArrayList();
                List offline = new ArrayList();
                Iterator i = set.iterator();
                while(i.hasNext()) {
                    String resource = (String)i.next();
                    if (resource.endsWith(cache.C_CACHE_OFFLINESUFFIX)) {
                        offline.add(resource);
                    } else {
                        online.add(resource);
                    }
                }
                Collections.sort(offline);
                Collections.sort(online);

                out.write("<h2>Online resources:</h2>");
                i = online.iterator();
                while(i.hasNext()) {
                    String resource = (String)i.next();
                    out.write("Resource: " + resource + " &nbsp; Key: " + cache.getCachedKey(resource, cms) + "<br>");
                    if (showall) {
                        Set variations = cache.getCachedVariations(resource, cms);
                        if (variations.size() > 0) {
	                        List outlist = new ArrayList();
                            for(Iterator j = variations.iterator(); j.hasNext(); outlist.add(j.next()));
                            Collections.sort(outlist);
                            Iterator s = outlist.iterator();
                            while (s.hasNext()) {
                                String v = (String)s.next();
                                out.write("&nbsp; &nbsp; &nbsp; &nbsp; Entry: " + v + "<br>");
                            }
                        }
                    }
                }
                if (online.size() == 0) out.write("There are no cached online resources!");

                out.write("<h2>Offline resources:</h2>");
                i = offline.iterator();
                while(i.hasNext()) {
                    String resource = (String)i.next();
                    out.write("Resource: " + resource + " &nbsp; Key: " + cache.getCachedKey(resource, cms) + "<br>");
                    if (showall) {
                        Set variations = cache.getCachedVariations(resource, cms);
                        if (variations.size() > 0) {
	                        List outlist = new ArrayList();
                            for(Iterator j = variations.iterator(); j.hasNext(); outlist.add(j.next()));
                            Collections.sort(outlist);
                            Iterator s = outlist.iterator();
                            while (s.hasNext()) {
                                String v = (String)s.next();
                                out.write("&nbsp; &nbsp; &nbsp; &nbsp; Entry: " + v + "<br>");
                            }
                        }
                    }
                }
                if (offline.size() == 0) out.write("There are no cached offline resources!");

            } else {
          		List online = new ArrayList();
          		online.addAll(set);
        		Collections.sort(online);
        		
                Iterator i = online.iterator();
                while(i.hasNext()) {
                    String resource = (String)i.next();
                    out.write("Resource: " + resource + " &nbsp; Key: " + cache.getCachedKey(resource, cms) + "<br>");
                    if (showall) {
                        Set variations = cache.getCachedVariations(resource, cms);
                        if (variations.size() > 0) {
	                        List outlist = new ArrayList();
                            for(Iterator j = variations.iterator(); j.hasNext(); outlist.add(j.next()));
                            Collections.sort(outlist);
                            Iterator s = outlist.iterator();
                            while (s.hasNext()) {
                                String v = (String)s.next();
                                out.write("&nbsp; &nbsp; &nbsp; &nbsp; Entry: " + v + "<br>");
                            }
                        }
                    }
                }
                if (set.size() == 0) out.write("The cache is currently empty!");
            }
        }
    }
%>

</body>
</html>