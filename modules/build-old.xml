<?xml version="1.0" encoding="UTF-8"?>

<project name="OpenCms Common Modules" default="war-all" basedir=".">
 	<property name="opencms.input" 						location="${basedir}/.." />
    <property name="opencms.output"						location="${opencms.input}/.." />
 	<property name="opencms.setup.input" 				location="${opencms.input}/webapp/setup" />
 	<property name="opencms.config.input" 				location="${opencms.input}/webapp/WEB-INF/config" />
    <property name="opencms.input.libs" 				location="${opencms.input}/webapp/WEB-INF/lib" />
	<property name="additional.modules" 				location="${opencms.output}/zip" />
    <property name="excludes"                  			value="**/CVS/*,**/.cvsignore,**/.nbattrs,**/.project,**/.classpath" />

 	<taskdef resource="net/sf/antcontrib/antlib.xml">
	  <classpath>
	    <pathelement location="${opencms.input.libs}/ant-contrib-1.0b1.jar"/>
	  </classpath>
	</taskdef>
	
	<taskdef resource="org/opencms/util/ant/taskdefs.properties" > 
	  <classpath>
	    <pathelement location="${opencms.input.libs}/ant-opencms-1.0.jar"/>
	  </classpath>
	</taskdef>
	
    <target name="init-all" 
    	description="initializes properties for the all mode">
    	
    	<property file="${basedir}/all-modules.properties" />
    	<if>
    		<not><isset property="modules.common.all" /></not>
    	  <then>
    		<fail>
    			property modules.common.all undefined.
    		</fail>
    	  </then>
    	  <else>
    	  	<echo message="all: ${modules.common.all}"/>
    	  </else>
    	</if>
        <sortlist property="modules.common.all" value="${modules.common.all}" override="true" />
    	
    	<for list="${modules.common.all}" param="module" trim="yes">
    	  <sequential>
        	<property name="@{module}.dir" value="${basedir}/@{module}" />
    	  </sequential>
    	</for>

		<!-- Copy the build-single.xml file to each module root folder -->
    	<for list="${modules.common.all}" param="module" trim="yes">
    	  <sequential>
    	  	<copy file="${basedir}/build-single.xml" tofile="${@{module}.dir}/build.xml" />
    	  </sequential>
    	</for>
    </target>
    	
    <target name="init-sel" 
    	depends="init-all" description="initializes properties">
    	
    	<property file="${basedir}/selection.properties" />
    	<echo message="sel: ${modules.common.selection}" />
	</target>
    	
    <target name="init-int" 
    	depends="init-sel" description="initializes properties">
    	
  	  <moduleprompt 
  	  	propertyname="modules.common.interactive"
  	    defaultvalue="${modules.common.selection}"
  	  	allmodules="${modules.common.all}"
  	  />
    	<if>
    	  <equals arg1="${modules.common.interactive}" arg2="__ABORT__" />
    	  <then>
    		<fail>aborted by User</fail>
    	  </then>
    	</if>
	</target>
    	
    <target name="clean-all" 
    	depends="init-all" description="Executes the do-clean target in the all mode">
	
		<antcall target="do-clean" >
			<param name="modules.var" value="${modules.common.all}"/>
		</antcall>
    </target>        
	
    <target name="clean-sel" 
    	depends="init-sel" description="Executes the do-clean target in the selection mode">
	
		<antcall target="do-clean" >
			<param name="modules.var" value="${modules.common.selection}"/>
		</antcall>
    </target>        
	
    <target name="clean-int" 
    	depends="init-int" description="Executes the do-clean target in the interactive mode">
	
		<antcall target="do-clean" >
			<param name="modules.var" value="${modules.common.interactive}"/>
		</antcall>
    </target>        
	
    <target name="do-clean" if="modules.var" 
    	description="(internal target) Cleans the given module generation directories">
    	
    	<for list="${modules.var}" param="module" trim="yes">
    	  <sequential>
    	  	<ant antfile="${@{module}.dir}/build.xml" target="clean" inheritAll="false" >
    	  		<property name="module.name" value="@{module}" />
    	  	</ant>
    	  </sequential>
    	</for>
    </target>        
	
    <target name="jar-all" 
    	depends="init-all" description="Executes the do-jar target in the all mode">
	
		<antcall target="do-jar" >
			<param name="modules.var" value="${modules.common.all}"/>
		</antcall>
    </target>
    			
    <target name="jar-sel" 
    	depends="init-sel" description="Executes the do-jar target in the selection mode">
	
		<antcall target="do-jar" >
			<param name="modules.var" value="${modules.common.selection}"/>
		</antcall>
    </target>
    			
    <target name="jar-int" 
    	depends="init-int" description="Executes the do-jar target in the interactive mode">
	
		<antcall target="do-jar" >
			<param name="modules.var" value="${modules.common.interactive}"/>
		</antcall>
    </target>
    			
    <target name="do-jar" if="modules.var"
    	description="(internal target) Generates the given .jar files">
	
    	<for list="${modules.var}" param="module" trim="yes">
    	  <sequential>
    	  	<ant antfile="${@{module}.dir}/build.xml" target="jar" inheritAll="false" >
    	  		<property name="module.name" value="@{module}" />
    	  	</ant>
    	  </sequential>
    	</for>
    </target>
    			
    <target name="dist-all" 
    	depends="init-all" description="Executes the do-dist target in the all mode">
	
		<antcall target="do-dist" >
			<param name="modules.var" value="${modules.common.all}"/>
		</antcall>
    </target>
    			
    <target name="dist-sel" 
    	depends="init-sel" description="Executes the do-dist target in the selection mode">
	
		<antcall target="do-dist" >
			<param name="modules.var" value="${modules.common.selection}"/>
		</antcall>
    </target>
    			
    <target name="dist-int" 
    	depends="init-int" description="Executes the do-dist target in the interactive mode">
	
		<antcall target="do-dist" >
			<param name="modules.var" value="${modules.common.interactive}"/>
		</antcall>
    </target>
    			
    <target name="do-dist" if="modules.var"
    	description="(internal target) Generates the given independent distros">
	
    	<for list="${modules.var}" param="module" trim="yes">
    	  <sequential>
    	  	<ant antfile="${@{module}.dir}/build.xml" target="dist" inheritAll="false" >
    	  		<property name="module.name" value="@{module}" />
    	  	</ant>
    	  </sequential>
    	</for>
    </target>
    			
    <target name="tomcat.copy-all" 
    	depends="init-all" description="Executes the do-tomcat.copy target in the all mode">
	
		<antcall target="do-tomcat.copy" >
			<param name="modules.var" value="${modules.common.all}"/>
		</antcall>
    </target>
    			
    <target name="tomcat.copy-sel" 
    	depends="init-sel" description="Executes the do-tomcat.copy target in the selection mode">
	
		<antcall target="do-tomcat.copy" >
			<param name="modules.var" value="${modules.common.selection}"/>
		</antcall>
    </target>
    			
    <target name="tomcat.copy-int" 
    	depends="init-int" description="Executes the do-tomcat.copy target in the interactive mode">
	
		<antcall target="do-tomcat.copy" >
			<param name="modules.var" value="${modules.common.interactive}"/>
		</antcall>
    </target>
    			
    <target name="do-tomcat.copy" if="modules.var"
    	description="(internal target) Copies the given updated modules to Tomcat directory">
	
    	<for list="${modules.var}" param="module" trim="yes">
    	  <sequential>
    	  	<ant antfile="${@{module}.dir}/build.xml" target="tomcat.copy" inheritAll="false" >
    	  		<property name="module.name" value="@{module}" />
    	  	</ant>
    	  </sequential>
    	</for>
    </target>
    			
    <target name="tomcat.update-all" 
    	depends="init-all" description="Executes the do-tomcat.update target in the all mode">
	
		<antcall target="do-tomcat.update" >
			<param name="modules.var" value="${modules.common.all}"/>
		</antcall>
    </target>
    			
    <target name="tomcat.update-sel" 
    	depends="init-sel" description="Executes the do-tomcat.update target in the selection mode">
	
		<antcall target="do-tomcat.update" >
			<param name="modules.var" value="${modules.common.selection}"/>
		</antcall>
    </target>
    			
    <target name="tomcat.update-int" 
    	depends="init-int" description="Executes the do-tomcat.update target in the interactive mode">
	
		<antcall target="do-tomcat.update" >
			<param name="modules.var" value="${modules.common.interactive}"/>
		</antcall>
    </target>
    			
    <target name="do-tomcat.update" if="modules.var"
    	description="(internal target) Recompiles changes and installs them in Tomcat webapps directory">
	
    	<for list="${modules.var}" param="module" trim="yes">
    	  <sequential>
    	  	<ant antfile="${@{module}.dir}/build.xml" target="tomcat.update" inheritAll="false" >
    	  		<property name="module.name" value="@{module}" />
    	  	</ant>
    	  </sequential>
    	</for>
    </target>
    			
    <target name="tomcat.all-all" 
    	depends="init-all" description="Executes the do-tomcat-all target in the all mode">
	
		<antcall target="do-tomcat.all" >
			<param name="modules.var" value="${modules.common.all}"/>
		</antcall>
    </target>
    			
    <target name="tomcat.all-sel" 
    	depends="init-sel" description="Executes the do-tomcat-all target in the selection mode">
	
		<antcall target="do-tomcat.all" >
			<param name="modules.var" value="${modules.common.selection}"/>
		</antcall>
    </target>
    			
    <target name="tomcat.all-int" 
    	depends="init-int" description="Executes the do-tomcat-all target in the interactive mode">
	
		<antcall target="do-tomcat.all" >
			<param name="modules.var" value="${modules.common.interactive}"/>
		</antcall>
    </target>

    <target name="do-tomcat.all" if="modules.var"
    		description="(internal target) Does a complete recompile of the module and installs it in Tomcat webapps directory">
	
    	<for list="${modules.var}" param="module" trim="yes">
    	  <sequential>
    	  	<ant antfile="${@{module}.dir}/build.xml" target="tomcat.all" inheritAll="false" >
    	  		<property name="module.name" value="@{module}" />
    	  	</ant>
    	  </sequential>
    	</for>
    </target>

    <target name="war-all" depends="dist-all" 
    	description="Executes the do-war target in the all mode">
    	
		<antcall target="do-war" >
			<param name="modules.var" value="${modules.common.all}"/>
		</antcall>
    </target>    
	
    <target name="war-sel" depends="dist-sel" 
    	description="Executes the do-war target in the selection mode">
    	        	
		<antcall target="do-war" >
			<param name="modules.var" value="${modules.common.selection}"/>
		</antcall>
    </target>    
 	
    <target name="war-int" depends="dist-int" 
    	description="Executes the do-war target in the interactive mode">
    	        	
		<antcall target="do-war" >
			<param name="modules.var" value="${modules.common.interactive}"/>
		</antcall>
    </target>    

	<target name="do-war" if="${modules.var}"
			description="(internal target) Updates the war file">
		
		<!-- be sure that the war file is uptodate -->
		<ant antfile="${opencms.input}/build.xml" target="war"/>

		<!-- tmp dir for WEB-INF/lib -->
		<mkdir dir="${opencms.output}/build/jars-modules" />

    	<!-- tmp dir for WEB-INF/packages/modules -->
		<mkdir dir="${opencms.output}/build/zips-modules" />

		<!-- get the jars and zips -->
		<for list="${modules.var}" param="module" trim="yes">
    	  <sequential>
    		<if>
    			<available file="${opencms.output}/build/jars-@{module}" />
    			<then>
    	           <copy todir="${opencms.output}/build/jars-modules" >   
    			    <fileset dir="${opencms.output}/build/jars-@{module}">
    			      <include name="*.jar"/>
    			    </fileset>
    	           </copy>
    			</then>		
     		</if>
           <copy todir="${opencms.output}/build/zips-modules" >   
		    <fileset dir="${additional.modules}">
		      <include name="@{module}_*.zip"/>
		    </fileset>
           </copy>
    	  </sequential>
    	</for>

		<!-- update the war file -->
		<war destfile="${opencms.output}/build/${app.name}.war" update="true" >            	     		
            <zipfileset dir="${opencms.output}/build/zips-modules" prefix="WEB-INF/packages/modules" includes="*.zip" />   
            <zipfileset dir="${opencms.output}/build/jars-modules" prefix="WEB-INF/lib" includes="*.jar" />   
        </war>              
		
		<!-- delete tmp dirs -->		
		<delete dir="${opencms.output}/build/jars-modules" />
		<delete dir="${opencms.output}/build/zips-modules" />		
		
	</target>

</project>
