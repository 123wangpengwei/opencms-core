<project name="OpenCms" default="compile" basedir=".">

    <property name="app.name"                   value="opencms"/>
    <property name="build.home"                 value="../build"/>
    <property name="zip.home"                   value="../zip"/>
    <property name="build.classes"              value="${build.home}/classes"/>
    <property name="build.inputlib"             value="../ExternalComponents"/>
    <property name="build.inputlib.servlet"     value="${build.inputlib}/servlet.jar"/>
    <property name="build.inputlib.activation"  value="${build.inputlib}/activation.jar"/>
    <property name="build.inputlib.mail"        value="${build.inputlib}/mail.jar"/>
    <property name="build.inputlib.xerces"      value="${build.inputlib}/xerces.jar"/>
    <property name="build.inputlib.oracle"      value="${build.inputlib}/classes12.zip"/>
    <property name="build.inputlib.mysql"       value="${build.inputlib}/mysql_2_uncomp.jar"/>
    <property name="build.inputlib.fop"         value="${build.inputlib}/fop_bin.jar"/>
    <property name="build.web"                  value="${build.home}/${app.name}"/>    
    <property name="build.webinf"               value="${build.web}/web-inf"/>    
    <property name="build.lib"                  value="${build.webinf}/lib"/>
    <property name="build.oclib"                value="${build.webinf}/oclib"/>

    <property name="db.url"                     value="jdbc:mysql://localhost:3306/opencms"/>
    <property name="db.setupurl"                value="jdbc:mysql://localhost:3306/mysql"/>
    <property name="db.user"                    value="root"/>
    <property name="db.password"                value=""/>
    <property name="db.driver"                  value="org.gjt.mm.mysql.Driver"/>


    <target name="prepare">
        <mkdir dir="${build.classes}"/>
        <mkdir dir="${build.home}"/>
        <mkdir dir="${build.lib}"/>
        <mkdir dir="${build.oclib}"/>
        <mkdir dir="${zip.home}"/>
    </target>


    <target name="clean">
        <delete dir="${build.home}"/>
    </target>
    

    <target name="compileclasses" depends="prepare">
       <javac 
            srcdir="src" 
            destdir="${build.classes}"
            classpath=" ${build.inputlib.servlet}:
                        ${build.inputlib.activation}:
                        ${build.inputlib.mail}:
                        ${build.inputlib.xerces}:
                        ${build.inputlib.oracle}:
                        ${build.inputlib.mysql}:
                        ${build.inputlib.fop}"
            debug="on" 
            optimize="off" 
            deprecation="off"/>

       <copy todir="${build.classes}">
            <fileset dir="src" includes="**/*.properties,**/*.txt"/>
       </copy>
    </target>
    
    <target name="jar" depends="compileclasses">
        <jar 
            jarfile="${build.lib}/opencmsboot.jar"
            basedir="${build.classes}"
            includes="com/opencms/boot/**,source/**"
            manifest="${build.classes}/mainClass.txt"
            />

        <jar 
            jarfile="${build.oclib}/opencms.jar"
            basedir="${build.classes}"
            includes="com/opencms/**"
            excludes="com/opencms/build/**"
            />
        
    </target>
    
    <target name="copy" depends="jar">
       <copy todir="${build.home}">
            <fileset dir="." includes="*.*" excludes="build.xml"/>
       </copy>
        
       <copy file="${build.inputlib.xerces}" todir="${build.oclib}"/>
       <copy file="${build.inputlib.mysql}" todir="${build.oclib}"/>
       <copy file="${build.inputlib.activation}" todir="${build.oclib}"/>
       <copy file="${build.inputlib.mail}" todir="${build.oclib}"/>
       <copy file="${build.inputlib.fop}" todir="${build.oclib}"/>
       
       <copy todir="${build.webinf}">
            <fileset dir="etc" excludes="*/CVS/*,web.xml"/>
       </copy>
       
       <copy todir="${build.web}">
            <fileset dir="web" excludes="*/CVS/*"/>
       </copy>

    </target>
    
    <target name="war" depends="copy">
        <war 
            warfile="${build.home}/${app.name}.war"
            webxml="etc/web.xml"
            basedir="${build.web}"
            />
    </target>
    
    <target name="setup" depends="copy">
        <sql 
            classpath="${build.inputlib.mysql}"
            driver="${db.driver}"
            url="${db.setupurl}"
            userid="${db.user}"
            password="${db.password}"
            autocommit="true"
            onerror="continue"
            >drop database opencms</sql>
        <sql 
            classpath="${build.inputlib.mysql}"
            driver="${db.driver}"
            url="${db.setupurl}"
            userid="${db.user}"
            password="${db.password}"
            autocommit="true"
            onerror="continue"
            >create database opencms</sql>
        <sql 
            classpath="${build.inputlib.mysql}"
            driver="${db.driver}"
            url="${db.url}"
            userid="${db.user}"
            password="${db.password}"
            autocommit="true"
            onerror="continue"
            src="${build.webinf}/ocsetup/mysql.sql"
            />
        <java 
            classname="com.opencms.boot.CmsMain"
            classpath="${build.lib}/opencmsboot.jar"
            dir="${build.webinf}"
            fork="true">
            <arg value="${build.webinf}/ocsetup/cmssetup.txt" />
        </java>
    </target>
    
    <target name="zip" depends="war">
        <zip
            zipfile="${zip.home}/opencms_build.zip"
            basedir="${build.home}"
            excludes="**/classes/,**/opencms/" />
    </target>
    

    <target name="all" depends="clean,zip"/>

    <target name="compile" depends="copy"/>

</project>